generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  PROVIDER
}

enum OrderStatus {
  Pending_Pickup
  In_Transit_to_Shop
  Arrived_at_Shop_Queuing
  Washing
  Washing_Complete_Start_Drying
  Drying_Complete_Start_Packing
  Out_for_Delivery
  Completed
  Cancelled
}

enum SSOProvider {
  GOOGLE
  FACEBOOK
  // Add more providers as needed
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  email     String   @unique
  password  String   
  role      Role     @default(USER)
  createdAt DateTime @default(now())

  // one-to-one optional: a user may own a single shop
  shop      Shop?    @relation("ShopOwner")

  // orders placed by this user
  orders    Order[]  @relation("user_orders")

  // SSO accounts linked to this user
  ssoAccounts SSOAccount[] @relation("user_sso")

  // login sessions
  loginSessions LoginSession[] @relation("user_login_sessions")

  // user profile
  profile UserProfile? @relation("user_profile")
}

model SSOAccount {
  id           String @id @default(uuid())
  userId       String
  user         User   @relation("user_sso", fields: [userId], references: [id])

  provider     SSOProvider // Changed to enum
  providerId   String @unique // unique ID from SSO provider

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([provider, providerId])
  @@index([userId])
}

model LoginSession {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation("user_login_sessions", fields: [userId], references: [id])

  accessToken  String
  refreshToken String
  device       String?  // optional: device info
  ipAddress    String?  // optional: IP address
  userAgent    String?  // optional: browser/user agent
  expiresAt    DateTime // expiration time for access token
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@index([accessToken])
}

model UserProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation("user_profile", fields: [userId], references: [id])

  firstName   String?
  lastName    String?
  bio         String?
  phoneNumber String?
  address     String?
  dateOfBirth DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

model Shop {
  id          String   @id @default(uuid())
  ownerId     String   @unique
  // relation to owner user
  owner       User     @relation("ShopOwner", fields: [ownerId], references: [id])

  name        String
  address     String
  description String?
  pricePerKg  Float    @default(5.0)
  ratingSum   Int      @default(0)
  ratingCount Int      @default(0)
  location    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // orders fulfilled by this shop/provider
  orders      Order[]  @relation("shop_order")
}

model Order {
  id           String      @id @default(uuid())

  // foreign keys
  userId       String
  shopId   String

  // relations
  user         User        @relation("user_orders", fields: [userId], references: [id])
  shop     Shop        @relation("shop_order", fields: [shopId], references: [id])

  providerName String?
  details      String?
  weightKg     Int?        @default(5)
  pricePerKg   Float?      @default(5.0)
  status       OrderStatus @default(Pending_Pickup)
  pickupAddress String?
  rating       Int?
  ratingComment String?
  ratedAt      DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([userId])
  @@index([shopId])
}
